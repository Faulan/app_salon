{% extends "layout.html" %}
{% block title %}Kelola Pelayan{% endblock %}
{% block content %}

<style>
    /* 1. SINKRONISASI KOLOM INPUT (BORDER UNGU AWAL) */
    .toolbar-element, .search-wrapper, .form-control-custom-style {
        height: 50px; 
        border-radius: 12px !important;
        display: flex;
        align-items: center;
        border: 1.5px solid var(--purple-main) !important; /* Ungu sejak awal */
        transition: all 0.3s ease;
        background-color: #ffffff;
        padding: 0 15px;
        overflow: hidden;
    }

    /* Efek Fokus Menebal (3px) Ungu */
    .toolbar-element:focus, .search-wrapper:focus-within, .form-control-custom-style:focus {
        border-width: 3px !important; 
        box-shadow: 0 0 10px rgba(106, 27, 154, 0.2) !important;
        outline: none;
    }

    /* 2. KHUSUS MODAL EDIT (TEMA KUNING EMAS) */
    #editStaffModal .form-control-custom-style, 
    #editStaffModal .toolbar-element {
        border-color: #ffc107 !important;
    }

    #editStaffModal .form-control-custom-style:focus, 
    #editStaffModal .toolbar-element:focus {
        border-width: 3px !important;
        border-color: #ffc107 !important;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.2) !important;
    }

    .search-input-group {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: none;
        width: 100%;
        display: flex;
        align-items: center;
    }

    .form-control-custom {
        border: none !important;
        box-shadow: none !important;
        height: 44px;
        padding-left: 10px;
        background: transparent !important;
        width: 100%;
        font-weight: 500;
    }

    /* 3. BUTTONS & UI */
    .btn-salon { 
        background: linear-gradient(45deg, var(--purple-main), var(--pink-main));
        color: white !important; 
        transition: all 0.3s; 
        border: none; 
        height: 50px; 
        border-radius: 12px; 
        font-weight: bold;
    }
    .btn-salon:hover { 
        background: linear-gradient(45deg, #511378, #ad1457); 
        transform: translateY(-2px); 
        box-shadow: 0 5px 15px rgba(173, 20, 87, 0.4); 
    }

    /* FIX: STYLE TOMBOL PILIH FOTO (INTERAKTIF UNGU) */
    .btn-pilih-foto-ungu {
        border: 2px solid var(--purple-main) !important;
        color: var(--purple-main) !important;
        background: transparent;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    /* Efek saat diklik (Aktif) jadi Ungu Solid */
    .btn-pilih-foto-ungu.active {
        background-color: var(--purple-main) !important;
        color: white !important;
    }

    .bg-pink-light { background-color: #fce4ec; color: #ad1457; border-radius: 50px; }
    .staff-row:hover { background-color: #fdf7ff; }
    .btn-white { background: white; border: 1px solid #eee; }
</style>

<div class="container-fluid py-4 text-start">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h3 class="fw-bold text-purple"><i class="bi bi-people-fill me-2"></i>Tim Hairstylist & Staf</h3>
            <p class="text-muted small">Manajemen profesional staf salon dan kontrol status kehadiran.</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="card card-salon border-0 shadow-sm p-3 bg-white">
                <small class="text-muted d-block uppercase fw-bold" style="font-size: 0.7rem;">TOTAL PERSONEL</small>
                <h3 class="fw-bold text-danger mb-0">{{ pelayan|length }} Orang</h3>
            </div>
        </div>
    </div>

    <div class="card card-salon shadow-sm border-0 mb-4 bg-white">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-5">
                    <div class="search-wrapper">
                        <div class="search-input-group">
                            <i class="bi bi-search text-purple ms-2"></i>
                            <input type="text" id="staffSearch" class="form-control form-control-custom shadow-none" placeholder="Cari nama atau spesialisasi...">
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="statusFilter" class="form-select toolbar-element shadow-none fw-semibold text-muted">
                        <option value="">-- Semua Status Staf --</option>
                        <option value="tersedia">ðŸŸ¢ Tersedia</option>
                        <option value="sibuk">ðŸŸ  Sibuk</option>
                        <option value="cuti">ðŸ”´ Cuti</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-salon w-100 justify-content-center fw-bold shadow-sm d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                        <i class="bi bi-plus-circle-fill me-2"></i> TAMBAH STAF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-salon shadow-sm border-0 overflow-hidden bg-white">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="staffTable">
                <thead class="table-light">
                    <tr style="background-color: var(--purple-main); color: white;">
                        <th class="ps-4 text-white">Profil Staf</th>
                        <th class="text-white">Bidang Keahlian</th>
                        <th class="text-white">Kontrol Status</th>
                        <th class="text-center text-white">Aksi</th>
                    </tr>
                </thead>
                <tbody id="staffTableBody">
                    {% for p in pelayan %}
                    <tr class="staff-row" data-status="{{ p.status_aktif }}">
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='uploads/' + p.foto_pelayan) if p.foto_pelayan else url_for('static', filename='img/default-user.png') }}" 
                                     alt="Foto" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #f8f9fa;">
                                <div>
                                    <div class="fw-bold text-dark staff-name">{{ p.nama_pelayan }}</div>
                                    <small class="text-muted">Kode: STF-0{{ p.id_pelayan }}</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-pink-light text-pink px-3 py-2">{{ p.spesialisasi }}</span></td>
                        <td>
                            <form action="/admin/pelayan/update_status/{{ p.id_pelayan }}" method="POST">
                                <select name="status_aktif" class="form-select form-select-sm border-0 bg-light fw-bold" onchange="this.form.submit()"
                                        style="width: 130px; border-radius: 8px; color: {% if p.status_aktif == 'tersedia' %}#2e7d32{% elif p.status_aktif == 'sibuk' %}#ef6c00{% else %}#c62828{% endif %};">
                                    <option value="tersedia" {% if p.status_aktif == 'tersedia' %}selected{% endif %}>ðŸŸ¢ Tersedia</option>
                                    <option value="sibuk" {% if p.status_aktif == 'sibuk' %}selected{% endif %}>ðŸŸ  Sibuk</option>
                                    <option value="cuti" {% if p.status_aktif == 'cuti' %}selected{% endif %}>ðŸ”´ Cuti</option>
                                </select>
                            </form>
                        </td>
                        <td class="text-center">
                            <div class="btn-group shadow-sm rounded-pill overflow-hidden border bg-white">
                                <button class="btn btn-sm btn-white text-info px-3" onclick="showStaffDetail('{{ p.nama_pelayan }}', '{{ p.spesialisasi }}', '{{ p.status_aktif }}', '{{ p.foto_pelayan }}')">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-white text-warning px-3" onclick="editStaff('{{ p.id_pelayan }}', '{{ p.nama_pelayan }}', '{{ p.spesialisasi }}', '{{ p.foto_pelayan }}')">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <a href="/admin/pelayan/delete/{{ p.id_pelayan }}" class="btn btn-sm btn-white text-danger px-3" onclick="return confirm('Hapus staf {{ p.nama_pelayan }}?')">
                                    <i class="bi bi-trash-fill"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-white py-3 border-0">
            <span class="text-muted small">Ditemukan <b id="displayedCount" class="text-purple">{{ pelayan|length }}</b> personel aktif.</span>
        </div>
    </div>
</div>

<div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px; overflow: hidden;">
            <div class="modal-header text-white border-0 py-3" style="background: linear-gradient(45deg, var(--purple-main), var(--pink-main));">
                <h5 class="modal-title fw-bold"><i class="bi bi-person-plus me-2"></i>Daftarkan Staf Baru</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/pelayan/add" method="POST" enctype="multipart/form-data">
                <div class="modal-body text-start p-4">
                    <div class="text-center mb-3">
                        <img id="previewFotoAdd" src="{{ url_for('static', filename='img/default-user.png') }}" 
                             class="rounded-circle border" style="width: 100px; height: 100px; object-fit: cover;">
                        <div class="mt-2">
                            <label for="uploadFotoAdd" class="btn btn-sm btn-pilih-foto-ungu rounded-pill px-4 shadow-sm" id="btnUploadAdd" onclick="this.classList.add('active')">
                                <i class="bi bi-camera-fill me-2"></i>Pilih Foto Staf
                            </label>
                            <input type="file" name="foto" id="uploadFotoAdd" hidden accept="image/*" onchange="previewImage(this, 'previewFotoAdd')">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Nama Lengkap</label>
                        <input type="text" name="nama" class="form-control form-control-custom-style shadow-none" placeholder="Nama Hairstylist" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Spesialisasi</label>
                        <input type="text" name="spesialisasi" class="form-control form-control-custom-style shadow-none" placeholder="Contoh: Senior Barber" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Status Awal</label>
                        <select name="status" class="form-select toolbar-element shadow-none">
                            <option value="tersedia">Tersedia</option>
                            <option value="sibuk">Sibuk</option>
                            <option value="cuti">Cuti</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="submit" class="btn btn-salon w-100 rounded-pill py-2 shadow">Simpan Data Staf</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px; overflow: hidden;">
            <div class="modal-header text-dark border-0 py-3" style="background-color: #ffc107;">
                <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i>Perbarui Data Staf</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/pelayan/update" method="POST" enctype="multipart/form-data">
                <div class="modal-body p-4 text-start">
                    <input type="hidden" name="id_pelayan" id="edit_id">
                    <div class="row text-center mb-4">
                        <div class="col-6">
                            <label class="small text-muted d-block mb-1">Foto Sekarang</label>
                            <img id="currentFotoEdit" src="" class="rounded-circle border shadow-sm" style="width: 90px; height: 90px; object-fit: cover;">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted d-block mb-1">Foto Baru</label>
                            <img id="previewFotoEdit" src="{{ url_for('static', filename='img/default-user.png') }}" class="rounded-circle border shadow-sm" style="width: 90px; height: 90px; object-fit: cover;">
                        </div>
                        <div class="col-12 mt-3">
                            <label for="uploadFotoEdit" class="btn btn-sm btn-outline-warning rounded-pill px-3" onclick="this.classList.add('active')">Ganti Foto Staf</label>
                            <input type="file" name="foto" id="uploadFotoEdit" hidden accept="image/*" onchange="previewImage(this, 'previewFotoEdit')">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Nama Lengkap</label>
                        <input type="text" name="nama" id="edit_nama" class="form-control form-control-custom-style shadow-none" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Spesialisasi</label>
                        <input type="text" name="spesialisasi" id="edit_spesialisasi" class="form-control form-control-custom-style shadow-none" required>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="submit" class="btn btn-warning w-100 py-2 fw-bold rounded-pill text-white shadow">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="detailStaffModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header text-white border-0 py-3" style="background: linear-gradient(45deg, var(--purple-main), var(--pink-main));">
                <h6 class="modal-title fw-bold"><i class="bi bi-info-circle me-2"></i>Profil Profesional Staf</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <img id="detFoto" src="" class="rounded-circle border mb-3 shadow" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #f8f9fa !important;">
                <h4 class="fw-bold text-dark mb-1" id="detNama"></h4>
                <span class="badge bg-pink-light text-pink px-3 py-2 mb-3" id="detSpesialisasi"></span>
                <hr class="my-3 opacity-10">
                <div class="text-start bg-light p-3 rounded-4">
                    <label class="text-muted small d-block uppercase fw-bold" style="font-size: 0.65rem;">Status Kehadiran Hari Ini</label>
                    <p class="fw-bold mb-0 fs-5" id="detStatus"></p>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-secondary w-100 rounded-pill py-2 shadow-sm fw-bold" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script>
const staffSearch = document.getElementById('staffSearch');
const statusFilter = document.getElementById('statusFilter');

function filterStaffTable() {
    const searchText = staffSearch.value.toLowerCase();
    const filterValue = statusFilter.value.toLowerCase();
    const rows = document.querySelectorAll('.staff-row');
    let count = 0;
    rows.forEach(row => {
        const staffName = row.querySelector('.staff-name').innerText.toLowerCase();
        const matchSearch = staffName.includes(searchText);
        const matchStatus = filterValue === "" || row.getAttribute('data-status').toLowerCase() === filterValue;
        if (matchSearch && matchStatus) { row.style.display = ''; count++; } else { row.style.display = 'none'; }
    });
    document.getElementById('displayedCount').innerText = count;
}

staffSearch.addEventListener('keyup', filterStaffTable);
statusFilter.addEventListener('change', filterStaffTable);

function previewImage(input, targetId) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) { document.getElementById(targetId).src = e.target.result; }
        reader.readAsDataURL(input.files[0]);
    }
}

function showStaffDetail(nama, spesialisasi, status, foto) {
    document.getElementById('detNama').innerText = nama;
    document.getElementById('detSpesialisasi').innerText = spesialisasi;
    const statusText = document.getElementById('detStatus');
    if (status.toLowerCase() === 'tersedia') {
        statusText.style.color = '#2e7d32';
        statusText.innerText = 'ðŸŸ¢ TERSEDIA';
    } else if (status.toLowerCase() === 'sibuk') {
        statusText.style.color = '#ef6c00';
        statusText.innerText = 'ðŸŸ  SIBUK';
    } else {
        statusText.style.color = '#c62828';
        statusText.innerText = 'ðŸ”´ CUTI';
    }
    document.getElementById('detFoto').src = foto ? "/static/uploads/" + foto : "/static/img/default-user.png";
    new bootstrap.Modal(document.getElementById('detailStaffModal')).show();
}

function editStaff(id, nama, spesialisasi, foto) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_nama').value = nama;
    document.getElementById('edit_spesialisasi').value = spesialisasi;
    const currentImg = foto ? "/static/uploads/" + foto : "/static/img/default-user.png";
    document.getElementById('currentFotoEdit').src = currentImg;
    document.getElementById('previewFotoEdit').src = "/static/img/default-user.png";
    new bootstrap.Modal(document.getElementById('editStaffModal')).show();
}

// RESET TOMBOL SAAT MODAL DITUTUP
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('hidden.bs.modal', function () {
        const btnAdd = document.getElementById('btnUploadAdd');
        if(btnAdd) btnAdd.classList.remove('active');
        const btnEdit = document.querySelector('label[for="uploadFotoEdit"]');
        if(btnEdit) btnEdit.classList.remove('active');
    });
});
</script>
{% endblock %}