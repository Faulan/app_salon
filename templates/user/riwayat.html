{% extends "layout.html" %}
{% block title %}Riwayat Booking{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* 1. SINKRONISASI FILTER */
    .toolbar-element, .search-wrapper, .date-input-container {
        height: 50px;
        border-radius: 12px !important;
        background-color: #ffffff;
        transition: all 0.3s ease;
        border: 1.5px solid var(--purple-main) !important;
        display: flex;
        align-items: center;
        overflow: hidden;
        padding: 0 15px;
    }

    .toolbar-element:focus-within, .search-wrapper:focus-within, .date-input-container:focus-within {
        border-width: 3px !important; 
        box-shadow: 0 0 10px rgba(106, 27, 154, 0.2) !important;
        outline: none;
    }

    .form-control-custom {
        border: none !important;
        box-shadow: none !important;
        height: 44px;
        padding-left: 10px;
        background: transparent !important;
        width: 100%;
        font-weight: 500;
    }

    /* 2. GAYA KALENDER RAPI (SINKRON STAFF & ADMIN) */
    .date-input-container {
        position: relative;
        width: 100%;
    }

    /* Ikon Kalender Ungu di Sisi Kanan */
    .date-input-container i {
        position: absolute;
        right: 15px;
        color: var(--purple-main);
        pointer-events: none;
        z-index: 5;
    }

    input[type="date"].form-control-custom {
        position: relative;
        z-index: 6;
        padding-right: 35px !important;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute;
        right: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        color: transparent;
        cursor: pointer;
    }

    /* 3. STYLE JUDUL & KATEGORI PINK */
    .text-purple-main { color: var(--purple-main) !important; }
    
    .badge-category-pink {
        background-color: #fdf2f6; 
        color: var(--pink-main); 
        border: 1px solid #f8d7da;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 8px;
        text-transform: uppercase;
        display: inline-block;
    }

    /* 4. UTILS & BUTTONS */
    .btn-reset-custom {
        height: 50px; border-radius: 12px; font-weight: bold;
        border: 2px solid #ff5252; color: #ff5252; background: white;
        display: flex; align-items: center; justify-content: center;
    }
    .btn-reset-custom:hover { background: #ff5252; color: white; transform: translateY(-2px); }

    .staf-avatar-table {
        width: 40px; height: 40px; border-radius: 50%;
        object-fit: cover; border: 2px solid #eee;
    }

    .modal-staf-img {
        width: 90px; height: 90px; border-radius: 50%;
        object-fit: cover; border: 3px solid var(--purple-main) !important;
        padding: 2px; background: white;
    }

    .detail-card-info {
        background: #fdfbff;
        border-left: 5px solid var(--purple-main);
        padding: 15px;
        border-radius: 12px;
    }
</style>

<div class="container-fluid py-4 text-start">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h3 class="fw-bold text-purple-main"><i class="bi bi-clock-history me-2"></i>Riwayat Perawatan Anda</h3>
            <p class="text-muted small">Pantau status reservasi dan rincian transaksi layanan salon Anda secara real-time.</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/user/katalog" class="btn btn-salon w-100 shadow-sm" style="height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-calendar-plus me-2"></i> BOOKING BARU
            </a>
        </div>
    </div>

    <div class="card card-salon border-0 mb-4 bg-white shadow-sm" style="border-radius: 20px;">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <div class="search-wrapper px-2">
                        <i class="bi bi-search text-purple ms-2"></i>
                        <input type="text" id="bookingSearch" class="form-control form-control-custom shadow-none" placeholder="Cari layanan/pelayan...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="filterStatus" class="form-select toolbar-element fw-semibold text-muted shadow-none">
                        <option value="">-- Semua Status --</option>
                        <option value="Menunggu">Menunggu</option>
                        <option value="Diterima">Diterima</option>
                        <option value="Selesai">Selesai</option>
                        <option value="Ditolak">Ditolak</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="date-input-container px-2">
                        <input type="date" id="filterTanggal" class="form-control form-control-custom shadow-none">
                        <i class="bi bi-calendar-event"></i>
                    </div>
                </div>
                <div class="col-md-2">
                    <button onclick="resetFilters()" class="btn btn-reset-custom w-100">
                        <i class="bi bi-arrow-clockwise me-1"></i> RESET
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm" style="border-radius: 15px;">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr style="background-color: var(--purple-main); color: white;">
                    <th class="ps-4 text-white">Waktu Booking</th>
                    <th class="text-white">Layanan Jasa</th>
                    <th class="text-white">Staf Pelayan</th>
                    <th class="text-center text-white">Status</th>
                    <th class="text-center text-white pe-4">Aksi</th>
                </tr>
            </thead>
            <tbody id="riwayatTableBody">
                {% for r in riwayat %}
                <tr class="booking-row" data-status="{{ r.status }}" data-date="{{ r.tgl_booking }}">
                    <td class="ps-4">
                        <div class="fw-bold text-dark">{{ r.tgl_booking }}</div>
                        <small class="text-muted"><i class="bi bi-clock me-1"></i>{{ r.jam_booking }} WIB</small>
                    </td>
                    <td>
                        <div class="fw-bold text-purple-main">{{ r.nama_layanan }}</div>
                        <span class="badge-category-pink">{{ r.kategori }}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='uploads/' + r.foto_pelayan) if r.foto_pelayan else url_for('static', filename='img/default-user.png') }}" 
                                 class="staf-avatar-table me-2 shadow-sm">
                            <span class="fw-semibold small text-dark">{{ r.nama_pelayan }}</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge {% if r.status == 'Menunggu' %}bg-warning text-dark{% elif r.status == 'Diterima' %}bg-info text-white{% elif r.status == 'Selesai' %}bg-success text-white{% else %}bg-danger text-white{% endif %} rounded-pill px-3 py-2" style="font-size: 0.75rem;">
                            {{ r.status }}
                        </span>
                    </td>
                    <td class="text-center pe-4">
                        <div class="btn-group shadow-sm rounded-pill overflow-hidden border bg-white">
                            <button class="btn btn-sm text-info px-3 border-0" title="Rincian"
                                    onclick="showDetailBooking('{{ r.tgl_booking }}', '{{ r.jam_booking }}', '{{ r.nama_layanan }}', '{{ r.nama_pelayan }}', '{{ r.status }}', '{{ r.harga }}', '{{ r.metode_bayar or 'Belum Bayar' }}', '{{ r.kategori }}', '{{ r.foto_pelayan }}', '{{ r.spesialisasi }}', '{{ r.uang_bayar }}', '{{ r.kembalian }}')">
                                <i class="bi bi-eye-fill"></i>
                            </button>
                            {% if r.status == 'Selesai' %}
                            <button class="btn btn-sm text-success px-3 border-start" title="Struk"
                                    onclick="showInvoice('{{ session['username'] }}', '{{ r.nama_layanan }}', '{{ r.nama_pelayan }}', '{{ r.total_bayar }}', '{{ r.metode_bayar }}', '{{ r.uang_bayar }}', '{{ r.kembalian }}')">
                                <i class="bi bi-receipt"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-5 text-muted">Belum ada riwayat pelayanan yang tercatat.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="detailBookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <div class="modal-header text-white border-0 py-3" style="background: linear-gradient(45deg, var(--purple-main), var(--pink-main)); border-radius: 25px 25px 0 0;">
                <h5 class="modal-title fw-bold"><i class="bi bi-stars me-2"></i>Rincian Reservasi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <img id="detFotoStaf" src="" class="modal-staf-img mb-3 shadow-sm">
                <h5 class="fw-bold text-dark mb-0" id="detPelayanTitle"></h5>
                <small class="text-muted fw-bold mb-3 d-block" id="detSpec"></small>

                <div class="detail-card-info mb-3 text-start">
                    <h5 class="fw-bold text-purple-main mb-0" id="detLayanan"></h5>
                    <span class="badge-category-pink mt-1" id="detKategori"></span>
                    <hr class="my-2 opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted fw-bold">STATUS TRANSAKSI</small>
                        <div class="badge rounded-pill px-3 py-1 shadow-sm" id="detStatusBadge"></div>
                    </div>
                </div>

                <div class="bg-light p-3 rounded-4 shadow-sm text-start">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted small fw-bold">JADWAL KEDATANGAN</span>
                        <span class="fw-bold text-dark small" id="detWaktu"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted small fw-bold">BIAYA LAYANAN</span>
                        <span class="fw-bold text-danger fs-5" id="detHarga"></span>
                    </div>
                    <div id="detMetodeArea">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted small fw-bold">METODE BAYAR</span>
                            <span class="fw-bold text-success small" id="detMetodeText"></span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn text-white w-100 rounded-pill py-2 mt-4 shadow" data-bs-dismiss="modal" style="background: var(--purple-main);">Tutup Rincian</button>
            </div>
        </div>
    </div>
</div>

{% include 'components/struk_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('bookingSearch');
    const filterStatus = document.getElementById('filterStatus');
    const filterTanggal = document.getElementById('filterTanggal');
    const rows = document.querySelectorAll('.booking-row');

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusTerm = filterStatus.value;
        const dateTerm = filterTanggal.value;
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            const status = row.getAttribute('data-status');
            const date = row.getAttribute('data-date');
            if (text.includes(searchTerm) && (statusTerm === "" || status === statusTerm) && (dateTerm === "" || date === dateTerm)) {
                row.style.display = "table-row";
            } else { row.style.display = "none"; }
        });
    }
    searchInput.addEventListener('keyup', applyFilters);
    filterStatus.addEventListener('change', applyFilters);
    filterTanggal.addEventListener('change', applyFilters);
});

function resetFilters() {
    document.getElementById('bookingSearch').value = "";
    document.getElementById('filterStatus').value = "";
    document.getElementById('filterTanggal').value = "";
    const rows = document.querySelectorAll('.booking-row');
    rows.forEach(row => row.style.display = "table-row");
}

function showDetailBooking(tgl, jam, layanan, pelayan, status, harga, metode, kategori, foto, spec, bayar, kembali) {
    document.getElementById('detLayanan').innerText = layanan;
    document.getElementById('detKategori').innerText = kategori;
    document.getElementById('detWaktu').innerText = tgl + " [" + jam + "]";
    document.getElementById('detPelayanTitle').innerText = pelayan;
    document.getElementById('detSpec').innerText = spec || "General Stylist";
    document.getElementById('detHarga').innerText = "Rp " + parseInt(harga).toLocaleString('id-ID');
    document.getElementById('detMetodeText').innerText = "ðŸ’³ " + (metode || "Belum Bayar");
    document.getElementById('detFotoStaf').src = foto ? "/static/uploads/" + foto : "/static/img/default-user.png";
    
    const badge = document.getElementById('detStatusBadge');
    badge.innerText = status.toUpperCase();
    badge.className = "badge rounded-pill px-3 py-1 shadow-sm " + 
                     (status === 'Menunggu' ? 'bg-warning text-dark' : 
                      status === 'Diterima' ? 'bg-info text-white' : 
                      status === 'Selesai' ? 'bg-success text-white' : 'bg-danger text-white');
    
    new bootstrap.Modal(document.getElementById('detailBookingModal')).show();
}

function showInvoice(nama, layanan, pelayan, total, metode, bayar, kembali) {
    document.getElementById('strukNama').innerText = nama;
    document.getElementById('strukLayanan').innerText = layanan;
    document.getElementById('strukPelayan').innerText = pelayan;
    document.getElementById('strukMetode').innerText = metode || 'Tunai';
    document.getElementById('strukTotal').innerText = "Rp " + parseInt(total).toLocaleString('id-ID');
    
    const tunaiArea = document.getElementById('strukTunaiDetail');
    if (metode === 'Tunai') {
        tunaiArea.style.display = 'block';
        document.getElementById('strukBayar').innerText = "Rp " + parseInt(bayar || total).toLocaleString('id-ID');
        document.getElementById('strukKembalian').innerText = "Rp " + parseInt(kembali || 0).toLocaleString('id-ID');
    } else {
        tunaiArea.style.display = 'none';
    }
    new bootstrap.Modal(document.getElementById('strukModal')).show();
}
</script>

{% endblock %}