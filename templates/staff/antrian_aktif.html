{% extends "layout.html" %}
{% block title %}Antrian & Kasir Pelayan{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* 1. SINKRONISASI TOTAL SEMUA KOLOM INPUT (BORDER UNGU AWAL) */
    .toolbar-element, 
    .search-wrapper, 
    .modal-body .form-control, 
    .modal-body .form-select, 
    #cashInput,
    input[type="date"].form-control-custom {
        height: 50px;
        border-radius: 12px !important;
        background-color: #ffffff;
        transition: all 0.3s ease;
        border: 1.5px solid var(--purple-main) !important;
        display: flex;
        align-items: center;
        overflow: hidden;
        padding: 0 15px;
    }

    /* Efek Fokus Menebal (3px) UNGU SOLID */
    .toolbar-element:focus-within,
    .search-wrapper:focus-within, 
    .modal-body .form-control:focus, 
    .modal-body .form-select:focus, 
    #cashInput:focus,
    input[type="date"].form-control-custom:focus {
        border-width: 3px !important; 
        border-color: var(--purple-main) !important;
        box-shadow: 0 0 10px rgba(106, 27, 154, 0.2) !important;
        outline: none;
    }

    .search-input-group { background: transparent; border: none; width: 100%; display: flex; align-items: center; }

    .form-control-custom {
        border: none !important;
        box-shadow: none !important;
        height: 44px;
        padding-left: 10px;
        background: transparent !important;
        width: 100%;
        font-weight: 500;
    }

    /* GAYA KALENDER RAPI */
    input[type="date"].form-control-custom { position: relative; padding-right: 40px !important; }
    input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute;
        right: 12px;
        filter: invert(18%) sepia(85%) saturate(2441%) hue-rotate(268deg) brightness(91%) contrast(101%);
        cursor: pointer;
    }

    /* 2. BUTTON RESET CUSTOM (SINKRON RIWAYAT_PELAYANAN.HTML) */
    .btn-reset-custom {
        height: 50px;
        border-radius: 12px;
        background-color: white;
        color: #ff5252;
        font-weight: bold;
        border: 2px solid #ff5252;
        transition: 0.3s;
    }
    .btn-reset-custom:hover { 
        background-color: #ff5252; 
        color: white; 
        transform: translateY(-2px); 
    }

    /* 3. UI COMPONENTS */
    .bg-pink-light { background-color: #fdf2f6; color: #ad1457; border: 1px solid #f8d7da; }
    .text-pink-custom { color: #ad1457 !important; }
    .btn-white { background: white; border: 1px solid #eee; }
    .booking-row:hover { background-color: #fdf7ff; }

    /* 4. LOGIKA TRANSISI PANEL KASIR */
    .booking-container { display: flex; width: 100%; gap: 0; transition: all 0.5s ease; align-items: flex-start; overflow: hidden; }
    #tableSection { flex: 1; width: 100%; transition: all 0.5s ease; }
    #cashierSection { width: 0; flex: 0; opacity: 0; visibility: hidden; overflow: hidden; transform: translateX(50px); transition: all 0.5s ease; }
    .cashier-active #tableSection { flex: 0 0 66%; margin-right: 20px; }
    .cashier-active #cashierSection { flex: 0 0 32%; width: auto; opacity: 1; visibility: visible; transform: translateX(0); }
</style>

<div class="container-fluid py-4">
    <div id="mainWrapper" class="booking-container">
        <div id="tableSection" class="text-start">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h3 class="fw-bold" style="color: var(--purple-main);"><i class="bi bi-person-workspace me-2"></i>Meja Kerja & Kasir Staff</h3>
                    <p class="text-muted small">Kelola antrian layanan Anda dan proses pembayaran langsung di sini.</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="card card-salon border-0 shadow-sm p-3 bg-white">
                        <small class="text-muted d-block uppercase fw-bold" style="font-size: 0.7rem;">SISA ANTRIAN SAYA</small>
                        <h3 class="fw-bold text-pink-custom mb-0" id="remainingCount">{{ bookings|length }} Pelanggan</h3>
                    </div>
                </div>
            </div>

            <div class="card card-salon shadow-sm border-0 mb-4 bg-white">
                <div class="card-body p-3">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <div class="search-wrapper">
                                <div class="search-input-group">
                                    <i class="bi bi-search text-purple ms-2"></i>
                                    <input type="text" id="searchInput" class="form-control form-control-custom shadow-none" placeholder="Cari nama pelanggan...">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <input type="date" id="filterDate" class="form-control form-control-custom shadow-none">
                        </div>
                        <div class="col-md-3">
                            <select id="statusFilter" class="form-select toolbar-element fw-semibold text-muted shadow-none">
                                <option value="">-- Semua Status --</option>
                                <option value="Menunggu">Menunggu</option>
                                <option value="Diterima">Diproses</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button onclick="resetAllFilters()" class="btn btn-reset-custom w-100 fw-bold">
                                <i class="bi bi-arrow-clockwise me-1"></i>RESET
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-salon shadow-sm border-0 overflow-hidden bg-white">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="bookingTable">
                        <thead class="table-light">
                            <tr style="background-color: var(--purple-main); color: white;">
                                <th class="ps-4 text-white">Pelanggan</th>
                                <th class="text-white">Jadwal</th>
                                <th class="text-white">Layanan</th>
                                <th class="text-white">Status</th>
                                <th class="text-center text-white">Aksi Kasir</th>
                            </tr>
                        </thead>
                        <tbody id="bookingTableBody">
                            {% for b in bookings %}
                            <tr class="booking-row" data-status="{{ b.status }}" data-id="{{ b.id_booking }}" data-date="{{ b.tgl_booking }}">
                                <td class="ps-4">
                                    <div class="fw-bold text-dark cust-name">{{ b.pelanggan }}</div>
                                    <small class="text-muted"><i class="bi bi-whatsapp me-1"></i>{{ b.no_hp }}</small>
                                </td>
                                <td>
                                    <div class="fw-semibold small">{{ b.tgl_booking }}</div>
                                    <small class="text-muted">{{ b.jam_booking }} WIB</small>
                                </td>
                                <td>
                                    <span class="badge bg-pink-light text-pink mb-1">{{ b.nama_layanan }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if b.status == 'Menunggu' %}bg-warning text-dark{% else %}bg-primary text-white{% endif %} rounded-pill px-3 py-2">
                                        {{ b.status }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center justify-content-center">
                                        {% if b.status == 'Menunggu' %}
                                            <a href="/update_status/{{ b.id_booking }}/Diterima" class="btn btn-sm btn-white text-primary px-4 fw-bold rounded-pill border shadow-sm">Terima</a>
                                        {% elif b.status == 'Diterima' %}
                                            <button class="btn btn-sm btn-success px-4 fw-bold rounded-pill shadow-sm" 
                                                    onclick="bukaKasir('{{ b.id_booking }}', '{{ b.pelanggan }}', '{{ b.nama_layanan }}', '{{ b.harga|default(0) }}', '{{ b.nama_pelayan }}')">
                                                BAYAR <i class="bi bi-chevron-right"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">Tidak ada antrian aktif untuk Anda.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="cashierSection">
            <div class="card card-salon border-0 shadow-lg sticky-top" style="top: 20px; border-top: 5px solid #198754 !important; border-radius: 15px;">
                <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0 text-success"><i class="bi bi-cart-check-fill me-2"></i>KASIR PELAYAN</h5>
                    <button class="btn-close" onclick="tutupKasir()"></button>
                </div>
                <div class="card-body p-4 text-start">
                    <div class="mb-4">
                        <label class="text-muted small d-block uppercase fw-bold" style="font-size: 0.65rem;">PELANGGAN</label>
                        <h5 id="posNama" class="fw-bold text-dark">-</h5>
                        <label class="text-muted small d-block mt-3 uppercase fw-bold" style="font-size: 0.65rem;">LAYANAN</label>
                        <p id="posLayanan" class="mb-0 text-purple fw-semibold">-</p>
                    </div>

                    <div class="p-3 bg-light rounded-3 mb-4 border-start border-4 border-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted fw-bold">Total Tagihan</span>
                            <h3 id="posTotalText" class="fw-bold mb-0 text-dark">Rp 0</h3>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small">METODE PEMBAYARAN</label>
                        <div class="d-flex gap-2 mb-3">
                            <input type="radio" class="btn-check" name="pay_method" id="pay_cash" value="Tunai" checked onchange="togglePayInput(this.value)">
                            <label class="btn btn-outline-success w-100 py-2 fw-bold" for="pay_cash">TUNAI</label>
                            <input type="radio" class="btn-check" name="pay_method" id="pay_qris" value="QRIS" onchange="togglePayInput(this.value)">
                            <label class="btn btn-outline-primary w-100 py-2 fw-bold" for="pay_qris">QRIS</label>
                            <input type="radio" class="btn-check" name="pay_method" id="pay_transfer" value="Transfer" onchange="togglePayInput(this.value)">
                            <label class="btn btn-outline-info w-100 py-2 fw-bold" for="pay_transfer">TRANSFER</label>
                        </div>
                    </div>

                    <div id="cashInputArea">
                        <div class="mb-3">
                            <label class="form-label fw-bold small">UANG DITERIMA (Rp)</label>
                            <input type="number" id="cashInput" class="form-control form-control-lg shadow-sm" placeholder="0">
                        </div>
                        <div class="mb-4 text-end">
                            <label class="form-label fw-bold small d-block text-start">KEMBALIAN</label>
                            <h2 id="changeText" class="fw-bold text-danger">Rp 0</h2>
                        </div>
                    </div>

                    <div id="digitalInputArea" class="d-none">
                        <div class="alert alert-info border-0 shadow-sm py-3" style="border-radius: 12px;">
                            <small class="fw-bold"><i class="bi bi-info-circle-fill"></i> Konfirmasi:</small>
                            <p class="small mb-0 mt-1 text-muted">Pastikan dana telah masuk ke sistem sebelum konfirmasi.</p>
                        </div>
                    </div>

                    <button type="button" onclick="prosesLunas()" id="posConfirmBtn" class="btn btn-success btn-lg w-100 fw-bold shadow disabled py-3 mt-2" style="border-radius: 12px;">
                        <i class="bi bi-check-circle-fill me-1"></i> KONFIRMASI LUNAS
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'components/struk_modal.html' %}

<script>
    let currentHarga = 0, currentBookingId = 0, currentNama = "", currentLayanan = "", currentPelayan = "";

    // LOGIKA FILTER
    const searchInput = document.getElementById('searchInput');
    const dateFilter = document.getElementById('filterDate');
    const statusFilter = document.getElementById('statusFilter');
    const rows = document.querySelectorAll('.booking-row');

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedDate = dateFilter.value;
        const selectedStatus = statusFilter.value;
        let count = 0;

        rows.forEach(row => {
            const name = row.querySelector('.cust-name').innerText.toLowerCase();
            const date = row.getAttribute('data-date');
            const status = row.getAttribute('data-status');

            const matchSearch = name.includes(searchTerm);
            const matchDate = !selectedDate || date === selectedDate;
            const matchStatus = !selectedStatus || status === selectedStatus;

            if (matchSearch && matchDate && matchStatus) {
                row.style.display = "";
                count++;
            } else {
                row.style.display = "none";
            }
        });
        document.getElementById('remainingCount').innerText = count + " Pelanggan";
    }

    function resetAllFilters() {
        searchInput.value = "";
        dateFilter.value = "";
        statusFilter.value = "";
        applyFilters();
    }

    searchInput.addEventListener('keyup', applyFilters);
    dateFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);

    // FUNGSI KASIR (TETAP SAMA)
    function bukaKasir(id, nama, layanan, harga, pelayan) {
        currentHarga = parseInt(harga); currentBookingId = id; currentNama = nama; currentLayanan = layanan; currentPelayan = pelayan;
        document.getElementById('mainWrapper').classList.add('cashier-active');
        document.getElementById('posNama').innerText = nama; 
        document.getElementById('posLayanan').innerText = layanan;
        document.getElementById('posTotalText').innerText = "Rp " + currentHarga.toLocaleString('id-ID');
        document.getElementById('cashInput').value = ""; 
        togglePayInput('Tunai');
    }

    function tutupKasir() { document.getElementById('mainWrapper').classList.remove('cashier-active'); }

    function togglePayInput(method) {
        const cashArea = document.getElementById('cashInputArea'), digitalArea = document.getElementById('digitalInputArea'), btn = document.getElementById('posConfirmBtn');
        if (method === 'Tunai') { cashArea.classList.remove('d-none'); digitalArea.classList.add('d-none'); validateCash(); } 
        else { cashArea.classList.add('d-none'); digitalArea.classList.remove('d-none'); btn.classList.remove('disabled'); }
    }

    function validateCash() {
        const cash = parseInt(document.getElementById('cashInput').value) || 0;
        const kembalian = cash - currentHarga;
        const display = document.getElementById('changeText'), btn = document.getElementById('posConfirmBtn');
        if (cash <= 0) { display.innerText = "Rp 0"; btn.classList.add('disabled'); } 
        else if (kembalian >= 0) { display.innerText = "Rp " + kembalian.toLocaleString('id-ID'); display.className = "fw-bold text-success"; btn.classList.remove('disabled'); } 
        else { display.innerText = "Uang Kurang!"; display.className = "fw-bold text-danger"; btn.classList.add('disabled'); }
    }

    document.getElementById('cashInput').addEventListener('keyup', validateCash);

    function prosesLunas() {
        const metode = document.querySelector('input[name="pay_method"]:checked').value;
        const cash = parseInt(document.getElementById('cashInput').value) || 0;
        const kembali = cash - currentHarga;
        window.location.href = `/update_status/${currentBookingId}/Selesai?metode=${metode}&bayar=${cash}&kembali=${kembali}`;
    }
</script>

{% endblock %}